set(MODS)
set(IMPORTS)
set(CALLS)

foreach(MOD ${PLUGINS})
    list(APPEND MODS "plugin-${MOD}")
    list(APPEND IMPORTS "\tplugin::ptr plugin_${MOD}()")
    list(APPEND CALLS "\t\t    plugin_${MOD},\n")
endforeach()

string(REPLACE ";" "" CALLS "${CALLS}")
string(REPLACE ";" ";\n" IMPORTS "${IMPORTS}")
file(WRITE "${CMAKE_CURRENT_BINARY_DIR}/src/plugin_load_plugins.cc" "// THIS FILE IS AUTOGENERATED\n"
    "\n"
    "#include <vector>\n"
    "#include <server/plugin.hh>\n"
    "\n"
    "namespace movies {\n"
    "${IMPORTS};\n"
    "\n"
    "\tplugin::list plugin::load_plugins() {\n"
    "\t\tusing loader_t = plugin::ptr (*)();\n"
    "\t\tstatic constexpr loader_t loaders[] = {\n"
    "${CALLS}"
    "\t\t};\n"
    "\n"
	"\t\tplugin::list result{};\n"
	"\t\tresult.reserve(std::size(loaders));\n"
	"\t\tfor (auto loader : loaders)\n"
	"\t\t\tresult.push_back(loader());\n"
	"\t\treturn result;\n"
    "\t};\n"
    "}  // namespace movies")

message(STATUS "${CMAKE_CURRENT_BINARY_DIR}/src/plugin_load_plugins.cc")
message(STATUS "${MODS}")

set(PROJECT_SOURCES
    src/main.cc
    src/service.cc
    src/service.hh
)

if (WIN32)
    list(APPEND PROJECT_SOURCES
        win32/${PROJECT_NAME}.rc
        win32/${PROJECT_NAME}.ico
        )
endif()
source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${PROJECT_SOURCES})
source_group(TREE ${CMAKE_CURRENT_BINARY_DIR} FILES "${CMAKE_CURRENT_BINARY_DIR}/src/plugin_load_plugins.cc")
list(APPEND PROJECT_SOURCES ${QM_FILES})

add_executable(${PROJECT_NAME} ${PROJECT_SOURCES} "${CMAKE_CURRENT_BINARY_DIR}/src/plugin_load_plugins.cc")

target_link_libraries(${PROJECT_NAME} PRIVATE websocket server ${MODS})
target_include_directories(${PROJECT_NAME} PRIVATE ${CMAKE_CURRENT_BINARY_DIR} ${CMAKE_CURRENT_SOURCE_DIR}/src)
# target_compile_definitions(${PROJECT_NAME} PRIVATE "-DPLUGIN_IMPORTS=${IMPORTS}" "-DPLUGIN_CALLS=${CALLS}")

